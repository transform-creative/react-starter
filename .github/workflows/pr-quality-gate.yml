name: ğŸ›¡ï¸ PR Quality Gate

# Trigger on Pull Requests targeting main
on:
  pull_request:
    branches: [ "main" ]

# Cancel previous runs if the user pushes new commits to the same PR
# (Saves you money/time on GitHub Actions minutes)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: ğŸ” Validate Code
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Automatically caches node_modules for speed

      # 3. Clean Install (npm ci is faster/safer than npm install for CI)
      - name: Install Dependencies
        run: npm ci

      # 4. EXPERT ADDITION: Secret Scanning
      # Ensures no one accidentally committed a supabase_service_key
      - name: ğŸ”‘ GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. EXPERT ADDITION: Linting
      # Catches bad code patterns (e.g. unused vars, bad useEffect deps)
      - name: ğŸ¨ Lint Code (ESLint)
        run: npm run lint
        # Note: Ensure your package.json script is "lint": "eslint ."

      # 6. YOUR REQUIREMENT: Type Checking
      # Vite ignores TS errors in dev; this forces a check.
      - name: ğŸ“ Type Check (TypeScript)
        run: npx tsc --noEmit

      # 7. YOUR REQUIREMENT: Security Vulnerabilities
      # We check ONLY production dependencies with high severity.
      # Checking dev-deps often causes false positives that break builds unnecessarily.
      - name: ğŸ›¡ï¸ Security Audit
        run: npm audit --production --audit-level=high